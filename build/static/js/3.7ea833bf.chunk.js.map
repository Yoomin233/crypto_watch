{"version":3,"sources":["components/useUpdateData.ts","components/chart.tsx"],"names":["TimeInterval","useUpdateData","id","period","useState","data","setData","loading","setLoading","getData","useCallback","axios","get","then","mappedData","Object","entries","points","map","key","value","time","Number","v","catch","e","finally","useEffect","subscriber","eventEmitter","subscribe","wsData","length","lastData","lastDataTime","Date","Math","floor","p","console","log","unsubscribe","themesData","chart","layout","backgroundColor","lineColor","textColor","watermark","color","crosshair","grid","vertLines","horzLines","series","topColor","bottomColor","TVChartWrapper","styled","div","Wrapper","TVChart","domRef","useRef","chartRef","seriesRef","current","timeScale","fitContent","getBoundingClientRect","width","height","createChart","handleScale","mouseWheel","pinch","axisPressedMouseMove","rightPriceScale","borderVisible","timeVisible","fixLeftEdge","fixRightEdge","tickMarkFormatter","tickMarkType","locale","toLocaleDateString","localization","timeFormatter","toLocaleString","priceFormatter","price","decimals","toFixed","addAreaSeries","lineWidth","applyOptions","className","undefined","ref","Spinner"],"mappings":"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","file":"static/js/3.7ea833bf.chunk.js","sourcesContent":["import axios from \"axios\";\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport eventEmitter from \"../utils/eventEmitter\";\n\nconst TimeInterval: any = {\n  \"1D\": 300,\n  \"7D\": 300,\n  \"1M\": 3600,\n  \"3M\": 3600,\n  \"1Y\": 86400,\n};\n\nconst useUpdateData = (id: number, period: string): [any[], boolean] => {\n  const [data, setData] = useState<any[]>([]);\n  const [loading, setLoading] = useState<boolean>(true);\n\n  //   const latestNewLine = useRef<number>(0);\n\n  const getData = useCallback(() => {\n    // clear();\n    setLoading(true);\n    return axios\n      .get(\n        `https://api.coinmarketcap.com/data-api/v3/cryptocurrency/detail/chart?id=${id}&range=${period}`\n      )\n      .then(({ data }) => {\n        const mappedData = Object.entries<any>(data.data.points).map(\n          ([key, value]) => ({\n            time: Number(key),\n            value: value.v[0],\n          })\n        );\n        setData(mappedData);\n        return mappedData;\n      })\n      .catch((e) => {\n        return [];\n      })\n      .finally(() => {\n        setLoading(false);\n      });\n\n    // return () => eventEmitter.unsubscribe(`WS-${id}`, subscriber);\n  }, [id, period]);\n\n  useEffect(() => {\n    getData();\n    const subscriber = eventEmitter.subscribe(`WS-${id}`, (wsData: any) => {\n      setData((data) => {\n        if (!data.length) return data;\n        const lastData = data[data.length - 1];\n        const lastDataTime = lastData.time * 1000;\n        const now = Number(new Date());\n        const shouldInsertNewData = TimeInterval[period] * 1000;\n        // console.log(now, lastDataTime, shouldInsertNewData);\n        if (now - lastDataTime >= shouldInsertNewData) {\n          // console.log(\"insert new line!\");\n          return [\n            ...data,\n            {\n              time: Math.floor(Number(new Date()) / 1000),\n              value: wsData.p,\n            },\n          ];\n        } else {\n          // lastData.time = now\n          // console.log(\"in-place update!\");\n          lastData.value = wsData.p;\n          return [...data];\n        }\n        // console.log(lastDataTime);\n        // // console.log(data);\n        // return data;\n      });\n    });\n    return () => {\n      console.log(\"unsubscribe!\");\n      eventEmitter.unsubscribe(`WS-${id}`, subscriber);\n    };\n  }, [id, period, getData]);\n\n  return [data, loading];\n};\n\nexport default useUpdateData;\n","import axios from \"axios\";\nimport {\n  BusinessDay,\n  createChart,\n  TickMarkType,\n  UTCTimestamp,\n} from \"lightweight-charts\";\nimport { useCallback, useEffect, useRef, useState } from \"react\";\n// import { EventEmitter } from \"stream\";\nimport styled from \"styled-components\";\nimport eventEmitter from \"../utils/eventEmitter\";\n// import useSubsequentUpdate from \"../hooks/useSubsequentUpdate\";\nimport Spinner from \"./Spinner\";\nimport useUpdateData from \"./useUpdateData\";\n\n// type DataStruct = { time: \"string\"; value: number };\n\nvar darkTheme = {\n  chart: {\n    layout: {\n      backgroundColor: \"transparent\",\n      lineColor: \"#2B2B43\",\n      textColor: \"#D9D9D9\",\n    },\n    watermark: {\n      color: \"rgba(0, 0, 0, 0)\",\n    },\n    crosshair: {\n      color: \"#758696\",\n    },\n    grid: {\n      vertLines: {\n        color: \"transparent\",\n      },\n      horzLines: {\n        color: \"transparent\",\n      },\n    },\n  },\n  series: {\n    topColor: \"rgba(32, 226, 47, 0.56)\",\n    bottomColor: \"rgba(32, 226, 47, 0.04)\",\n    lineColor: \"rgba(32, 226, 47, 1)\",\n  },\n};\n\nconst lightTheme = {\n  chart: {\n    layout: {\n      backgroundColor: \"#FFFFFF\",\n      lineColor: \"#2B2B43\",\n      textColor: \"#191919\",\n    },\n    watermark: {\n      color: \"rgba(0, 0, 0, 0)\",\n    },\n    grid: {\n      vertLines: {\n        visible: false,\n      },\n      horzLines: {\n        color: \"#f0f3fa\",\n      },\n    },\n  },\n  series: {\n    topColor: \"rgba(33, 150, 243, 0.56)\",\n    bottomColor: \"rgba(33, 150, 243, 0.04)\",\n    lineColor: \"rgba(33, 150, 243, 1)\",\n  },\n};\n\nvar themesData: any = {\n  Dark: darkTheme,\n  Light: lightTheme,\n};\n\nconst TVChartWrapper = styled.div`\n  height: 100%;\n  width: 100%;\n`;\n\nconst Wrapper = styled.div`\n  width: 100%;\n  height: 100%;\n  position: relative;\n  &.loading {\n    div.tv-lightweight-charts {\n      filter: blur(4px);\n    }\n  }\n  > span {\n    position: absolute;\n    top: 0;\n    left: 0;\n  }\n`;\n\nconst TVChart: React.FC<{ id: number; period: string }> = ({\n  id = 1,\n  period = \"1D\",\n}) => {\n  const domRef = useRef<HTMLDivElement>(null);\n\n  const chartRef = useRef<any>(null);\n  const seriesRef = useRef<any>(null);\n\n  const clear = () => {\n    if (chartRef.current) {\n      chartRef.current.remove();\n    }\n  };\n\n  const [data, loading] = useUpdateData(id, period);\n\n  //   const timerRef = useRef(null)\n\n  //   const [loading, setLoading] = useState<boolean>(true);\n  //   const [error, setError] = useState(false);\n\n  //   useEffect(() => {\n  //     if (loading) {\n  //       console.log(\"race!\");\n  //       timerRef.current = setTimeout(() => setError(true), 5000)\n  //     } else {\n\n  //     }\n  //   }, [loading]);\n\n  //   const getData = useCallback(() => {\n  //     return axios\n  //       .get(\n  //         `https://api.coinmarketcap.com/data-api/v3/cryptocurrency/detail/chart?id=${id}&range=${period}`\n  //       )\n  //       .then(({ data }) => {\n  //         const mappedData = Object.entries<any>(data.data.points).map(\n  //           ([key, value]) => ({\n  //             time: Number(key),\n  //             value: value.v[0],\n  //           })\n  //         );\n  //         setData(mappedData);\n  //         return mappedData;\n  //       })\n  //       .catch((e) => {\n  //         return [];\n  //       });\n  //   }, [id, period]);\n\n  useEffect(() => {\n    // console.log(\"render!\", domRef.current);\n    if (!domRef.current) return;\n\n    // console.log('update!', data)\n\n    // console.log(domRef.current, chartRef.current, seriesRef.current);\n\n    if (chartRef.current && seriesRef.current) {\n      seriesRef.current.setData(data);\n      chartRef.current.timeScale().fitContent();\n      return;\n    }\n\n    // clear();\n    // setLoading(true);\n\n    // console.log(\"init render!\", data);\n    const { width, height } = domRef.current.getBoundingClientRect();\n\n    const chart = createChart(domRef.current, {\n      width,\n      height,\n      handleScale: {\n        mouseWheel: false,\n        pinch: false,\n        axisPressedMouseMove: false,\n      },\n      rightPriceScale: {\n        borderVisible: false,\n      },\n      timeScale: {\n        borderVisible: false,\n        timeVisible: true,\n        fixLeftEdge: true,\n        fixRightEdge: true,\n        tickMarkFormatter: (\n          time: UTCTimestamp | BusinessDay,\n          tickMarkType: TickMarkType,\n          locale: string\n        ) => {\n          return new Date(Number(time) * 1000).toLocaleDateString();\n\n          //   console.log(time, tickMarkType);\n          //   return \"333\";\n        },\n      },\n      localization: {\n        timeFormatter: (time: BusinessDay | UTCTimestamp) => {\n          // console.log(time);\n          return new Date(Number(time) * 1000).toLocaleString();\n          // return dayjs.unix(time).toDate().toLocaleDateString(locale);\n        },\n        priceFormatter: (price: number) => {\n          const decimals = price <= 0.01 ? 6 : price < 1 ? 4 : 2;\n          return price.toFixed(decimals);\n        },\n      },\n    });\n\n    chartRef.current = chart;\n\n    seriesRef.current = chart.addAreaSeries({\n      topColor: \"rgba(33, 150, 243, 0.56)\",\n      bottomColor: \"rgba(33, 150, 243, 0.04)\",\n      lineColor: \"rgba(33, 150, 243, 1)\",\n      lineWidth: 1,\n    });\n\n    chart.applyOptions(themesData[\"Dark\"].chart);\n    seriesRef.current.applyOptions(themesData[\"Dark\"].series);\n\n    // setLoading(false);\n\n    chart.timeScale().fitContent();\n\n    seriesRef.current.setData(data);\n\n    // console.log(\"mount!!\");\n\n    //   seriesRef.current.setData(data as any);\n    //   areaSeries.re\n\n    //   subscriber = eventEmitter.subscribe(`WS-${id}`, (wsData: any) => {\n    //     setData((data) => [\n    //       ...data,\n    //       {\n    //         time: Math.floor(Number(new Date()) / 1000),\n    //         value: wsData.p,\n    //       },\n    //     ]);\n    //   });\n    // });\n    // return () => eventEmitter.unsubscribe(`WS-${id}`, subscriber);\n  }, [id, data]);\n\n  //   useEffect(() => {\n  //     clear();\n  //   }, [period]);\n\n  //   useEffect(() => {\n  //     console.log(\"data update!\", seriesRef.current);\n  //     if (seriesRef.current && data.length) {\n  //       //   console.log(\"update!\");\n  //       seriesRef.current.setData(data as any);\n  //     }\n  //   }, [data]);\n\n  //   console.log(data);\n\n  //   if (!data.length) return ;\n  return (\n    <Wrapper className={loading ? \"loading\" : undefined}>\n      <TVChartWrapper ref={domRef}></TVChartWrapper>\n      {loading && <Spinner></Spinner>}\n    </Wrapper>\n  );\n};\n\nexport default TVChart;\n"],"sourceRoot":""}